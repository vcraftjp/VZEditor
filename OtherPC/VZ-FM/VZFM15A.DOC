===============================================================================
        ＶZ １.６０  富 士 通 Ｆ Ｍ シ リ ー ズ 移 植 版 に つ い て

　　　    　　　　　　　　  ＶＺＦＭ Ｌ１５a
                                                              k.tok（徳田楠男）
                                                         NIFTY-Serve : PEC00071
===============================================================================

■　差分対象

　　今回は，オリジナル（PC98版）VZ.COM V1.60 との差分です。
  　ワキチ氏作 WSP を使用した自己アップデート形式になっていますので。特にツール
  　は必要ありません。

  　差分対象は以下のものです。

	VZ      COM        57,648 93-12-06    2:00


■　ＦＭ版ＶＺの作成方法

    README.DOC にも書いてありますが，

    　カレントディレクトリにＦＭ版の差分（自己更新プログラムになってます）ファ
    イルをおいてください。
    
  1)  VZ 1.60 オリジナルフロッピー (PC98版) の ルートディレクトリにある VZ.COM
      をカレントディレクトリへコピーしてください.

  2)  必要なＦＭ版の更新プログラムを実行してください。

	[例]
		C>copy a:\vz.com
		C>vzr5015a

  3)  (2) により, FM版のVZができあがります。このドキュメントと一緒に入っている
    VZFM.DEF と VZFL.DEF をお使いください。
    VZFM.DEF は, 自分の使用する VZ の実行プログラム名に合わせて適当な名前に変更
    して使用してください. (VZR50.COM ならば VZR50.DEF)


■　L15  からの変更点						94/04/10

  1)  20行/25行の切り換えをすると，編集中のファイルにゴミデータが混入するバグを
    修正しました。和田さんがこのバグを指摘してくれました。ありがとうございます。

■　L14d からの変更点						94/03/28

      今回の 1.60 への対応は，主として Aiming Off さんによって行われました。
    また，太田さんの改造による機能追加も盛り込まれてます。
    以下の文章及び，VZFM.DOC は，本人の許可を得て Aiming Off さんの書かれたドキ
    ュメントから引用しています。
    変更点の詳細な内容は，VZFM.DOC を参照してください。

  1)  VzFM V1.57 L14d から変更／削除されたオプション変数

	Ne  →  Xe	: 98オリジナル版でシステム変数として ne が採用されたた
	　　　　　　　　　め, 名称変更 (暫定). VZ.DEF ファイルの中で Ne　が定義
	　　　　　　　　　されていると, カスタマイズエラーとなる。

	SM  →  SF	: 98オリジナル版でシステム変数として sm が採用されたた
	　　　　　　　　　め, 名称変更 (String/Mask の頭文字からString/Fepの頭
	　　　　　　　　　文字にした)。
			  VZ.DEF ファイルの中で SM が定義されていると, システム
			  変数 sm を変更することになり, 危険。

	CF  →  削除	: ファイラの動作を指定していたが, これと同じ機能は 98オ
	                  リジナル版でオプション変数 FM で指定できるようになっ
	                  たため, このオプションは削除。

	HK  →  削除	: PC98 の半角２バイト文字の処理を行うか否かを指定して
	　　　　　　　　　いたが, この機能は VM オプション変数の中に含めて, 独
	　　　　　　　　　立した HK フラグは削除した。 (後述参照)

	NC  →  削除	: 機種チェックをスキップするオプションだが, VZ の起動時
	　　　　　　　　　にしか意味を持たないオプションであり, 無駄なため。
	　　　　　　　　　また，オリジナルで -w オプションが廃止されてこれの必
	　　　　　　　　　要性がなくなった。

	Bd  新設	: Eb+ で環境変数 VZBAK が指定されている時の処理を指定す
	                  る。 (詳細は後述)

	VM  内容変更	: 従来は何も意味を持たないオプション変数だったが，画面
			  表示に関するオプションを指定できるようにした。
			  (詳細は後述)

	Dg  内容変更	: 従来は丸文字表示の有無を指定していたが, 上記の VM オ
			  プションで指定する画面表示制御を行うか否かを指定する｡
			   (詳細は後述)

      上記以外は, VZ V1.60 の 98オリジナル版で変更された内容に準じます。特に,
    Bq, GV, Ha, w は意味を持たなくなっているので注意してください。


  2)  機種ＩＤ

      VZ V1.60 では, 機種毎に固有の ID を持ちます. この ID を使うことにより，一
      つの DEF ファイルを #if 等の条件文で判断させて複数の機種で共用することが
    　できます。このため, DEF ファイルのメインテナンスが楽になります。
      FM版の機種 ID は, 仮に以下のとおり設定しました。

	FM16B	: ＦＭ１６β版					VZ16B.COM
	TOWNS	: ＦＭ−ＴＯＷＮＳ版				VZFMT.COM
	FMRH	: ＦＭＲ高解像度機種 (FMR-80/70/60/280)		VZR60.COM
	FMRM	: ＦＭＲ中解像度機種 (FMR-50(含NB)/30/10)	VZR50/VZR30

      これらの機種 ID は, 実際にどういう機種で使われているかを判断している訳で
    はなく, どの機種用の VZ を使用しているかによって決まります。例えば，VZR50.
    COM は TOWNS でも使用できますが, その場合には FMRM が ID となります。


  3)  高解像度機種のアトリビュート指定 (Aiming Off氏)		>>VZFM.DOC 380

      高解像度機種版のみ, 画面表示の属性指定 (An〜Ay) を拡張して背景色が指定で
    きるようになりました。


  4)  高解像度機種のカーソル色指定 (Aiming Off氏)		>>VZFM.DOC 327

      高解像度機種版のみ, カーソルの色を指定できるよう拡張しました。


  5)  高解像度機種のアンダライン色指定 (Aiming Off氏)		>>VZFM.DOC 457

      高解像度機種でアンダラインやアンダスコアの色を設定できるようにしました。
    色の指定は, VZFM.DEF の中の『* E その他』の中で未使用のパレットテーブルの箇
    所で指定します。


  6)  ファイラー表示の拡張 (by 太田亘一 氏: PBB02717)		>>VZFM.DOC 1004

　　  オリジナルの VZ V1.60 では，ファイラーでボリュームラベルが表示されません｡
      また，VZ 1.60 ではファイルの属性によりカラー表示されるように変更されまし
    たが，アーカイブ属性の有無はカラー表示の対象から外れているため，一目では区
    別できません。これを改善する改良が太田氏によってなされており，ＦＭ版でもこ
    れを採用しました。


  7)  コマンドメニューオプション %/ の追加 (by 太田亘一 氏: PBB02717)
  								>>VZFM.DOC 1047

　　  VZ 1.60 でファイラーの機能が強化され, コマンドメニューに %G や %F 等が指
    定できるようになり, VZ だけでも他のファイラーと同程度の機能を実現することが
    可能になりました。
      しかし, この機能強化でも限界があり, ２ウィンドウ表示状態でターゲットファ
    イルが選択されていないと %2%F の指定でターゲットディレクトリ名とファイル名
     (入力文字列) が '\' で区切られることなくくっついてしまいます。かと言って,
    %2%\%F という指定に変更すると今度はターゲットファイルが選択されている時にタ
    ーゲットファイル名の後ろに余計な '\' が付いてしまいます。
      これを避けるため, %\ とほぼ同じ機能でターゲットを選択していない時には '\'
    を付加しない %/ というオプションを追加する拡張が太田氏によってなされました｡
      これを, ＦＭ版でも採用してみました。

      さらに，Aiming Off氏により，次のように追加・改良が加えられ，次のような仕
    様となっています。

	%/：「\」 を補完。直前がスペースの場合はスキップ。「%2」の後に
	    指定された場合，ターゲットファイルとしてディレクトリ以外を
　          選択している時はスキップ。

	%E：入力窓で文字列を取得。「%2」の後に指定された場合，ターゲッ
	    トファイルとしてディレクトリ以外を選択している時はスキップ。


  8)  VZBAK ディレクトリの非作成 (by 太田亘一 氏: PBB02717)	>>VZFM.DOC 1097

      既に VZBAK の指定ディレクトリがある場合だけバックアップを行い, そのディレ
    クトリがない場合にはバックアップを行わない改良がなされました。ＦＭ版も, こ
    れを採用してみました。
      オプション Bd+ を指定すると, そのドライブに環境変数 VZBAK に指定されたデ
    ィレクトリがない場合に新たにディレクトリを作成するようなことはしません。
      なお, Eb- の場合や環境変数 VZBAK が指定されていない場合には, この機能は意
    味を持ちません。

    Bd+		… VZBAK で指定されたディレクトリがない場合はバックアップしない
    Bd-		… VZBAK で指定されたディレクトリがなければ，作成してからバック
		   アップ（デフォルト）


  9)  PC-9801 特殊文字や OASYS 特殊文字の変換表示 (Aiming Off)	>>VZFM.DOC 704

      PC-9801 で使われている NEC 特有の文字や OASYS で使われている特殊文字は, 
    通常では FMR では表示されなかったり化けて表示されたりして, 内容がわかりませ
    ん。これを, 限定付きながら, FMR でも変換して表示されるようにしました。どの
    ような変換をするかは, オプション変数 VM で指定します.

	VM :	+32 +16 +8 +4 +2 +1
		  x  x  x  x  x  1	まるこむ対応をする (旧 Dg)
		  x  x  x  x  1  x	JIS罫線の変換表示をする
		  x  x  x  1  x  x	PC-9801 特殊文字の変換表示をする
		  x  x  1  x  x  x	PC-9801 2バイト半角文字対応 (旧 HK)
		  x  1  x  x  x  x	OASYS 特殊文字の変換表示をする
		  1  x  x  x  x  x	富士通拡張文字の変換表示をする


 10)  数字キーによる罫線・記号入力　(Aiming Off)		>>VZFM.DOC 276

      VzFM V1.57 L14d ではテンキーと [CTRL]/[ALT] キーとの組み合わせにより罫線
    や記号が入力できるようになっていましたが, これをテンキーではなくフルキーボ
    ード側の数字キーとの組み合わせでも入力できるように変更しました。

  ★注★
      VZ.DEF の『* E その他』の設定をする際には, 同じ行にコメントを書くことがで
      きません。VzFM V1.57 L14d 付属の VZFMR.DEF には同じ行にコメントがついてい
      ますが, このコメントは削除するか次の行に書き改めてください。誤動作の恐れ
      があります。


 11)  オートセーブ (Aiming Off氏)

      オートセーブをするための "!Timer" イベントマクロは, 現在のところ MS-DOS 
    V5.0 (以降?) でしか正常に動作しません。MS-DOS V3.1 や TOWNS OS では，日本
    語入力中に誤動作することがあります。


 12)  他の機種版の特殊キー指定					>>VZFM.DOC 120

      オリジナルの VZ 1.60 の修正に合わせて，富士通以外の機種の特殊キーである
    [PGDN],[PGUP],[CLR],[HELP] のキーアサインが DEF ファイル内で指定された場合
    には, [RLUP],[RLDN],[HOME],[CAN] と同等に扱うようになりました。
      [END]（IBM系）や[NFER]（PC98系）が指定された場合にはエラーとなります。
      FM16β版 については, [RLUP],[RLDN] も有効にしてあります。ただし，あまり意
    味のない割り当てになっています。
      FM16β / FMR専用のキー名称は当然ながら，それぞれの専用の機種版の VZでしか
    使えません。


 13)  MS-KANJI / ATOK7

　　　従来からソースには組み込まれてましたが，MS-KANJI や ATOK7 を標準で使える
　　ようにしました。ただし, 動作確認はしていません。


 14)  long int 計算の関数 &z の廃止

      98 オリジナル版で long int 計算の関数 (&Le &La &Ls &Lc &Ia &Is &Im &Id)が
    サポートされ, &z には別の関数が割り当てられました。このため,VzFM V1.57 L14d
    で定義されていた long int 計算関数の &z は廃止しました。


 15)  GVRAM の使用

      PC98版オリジナル同様, GVRAM の使用は廃止しています。


 16)  DEF ファイルの『* E その他』の項の構成

      DEF ファイルの『* E その他』の構成は 98版等と同じにしました. カナ変換テー
    ブルや FMR (高解像度版,TOWNS版以外) でのパレットテーブルは意味を持ちません
    が, 番号を同じにするためにそのままにしています。


 17)  type vz.com による版数表示

      従来は, 『type vz.com』のように VZ???.COM の内容を画面に表示させると『VZ1
    .57 L14d』のように FM 固有のレベルも表示されました. しかし, 内部の都合上, 
    このレベル表示をやめて『VZ1.60』というバージョン表示だけになります。


 18)  TOWNS版で LCON に標準で対応

      マシーンＭ氏作の TOWNS-OS 用の LCON (26行以上表示可能なコンソール) に対応
    するための L14dに対する差分が，マシーンＭ氏自身の手によって公表されてました
    が，今回，その修正を標準で組み込みました。
    　ただし，以下のような制限があります。

      LCON 上で VZ を常駐させた直後, あるいはすでに常駐している状態から LCON を
    起動した直後コマンドラインで入力する文字が表示されない｡(正常に入力はされる)

      この場合，一度でもVZの編集画面に移行した後は，正常に表示されるようになり
    ます。[ESC] を２回叩くだけでもいいです。


 19)  [BREAK]キー割り込みによるハングを修正 (Aiming Off氏)

      L14d で頻発 (特に高解像度機版) していた [BREAK]キー割り込みによるハングは
    Aiming Off 氏によって修正されました。


 20)  DOS のﾌｧﾝｸｼｮﾝｷｰ, 特殊キーの割り当て内容が破壊されることがあったのを修正
      (Aiming Off氏)

      これは，L15β版 (評価版) で発生していた『削除文字列が正常に復活しない』バ
    グと原因は同じです。1.60 になってたまたま削除文字列バッファが隣接したため顕
    在化するようになりましたが，ＦＭ版の 1.5 の初期の頃から潜んでいたバグです（
    たぶん）。やっと退治しました。とんだ凡ミスでした。
      Papara さん，和田さんの詳細なバグの解析のおかげで解決できました。ありがと
    うございます。


 21)  シフトキーフラグ (ks) の内容を変更			>>VZFM.DOC 596

      他機種 (特に PC98) 用のマクロを移植しやすくするため，ks の内容を変更しま
    した。この結果，[カナ] 以外の値が，PC98 と共通になりました。


 22)  TOWNS版で背景色のパレットを変更出来るようにしました	>>VZFM.DOC 843

      パレットテーブルの最初の値は, テキストの黒のパレット指定でしたたが，グラ
    フィックの黒のパレットの指定とみなすことにしました。従来は，この黒のパレッ
    トは無視してました。
      これに伴い，中解像度機種では，不必要な Dv オプションをこの機能の制御オプ
    ションとして使うことにしました。
      Dv+ 時にグラフィックのパレットを変更します。Dv- 時には従来と同様です。


 23)  TOWNS版で Windows 上で動作しているときにはパレットを無効にする

      Windows 上のDOS窓でも動作できるようにするために Windows 上で動作している
    時には，パレットの変更操作はしないようにしました。本来なら，DOS窓の時だけパ
    レットをいじらなければ良いのですが，DOS窓なのかフルスクリーンなのか知る方法
    が分からなかったためこのような仕様となりました。


 24)  オリジナル版のバグ修正

      98オリジナル版に残っているバグの中で, FVC に修正情報がアップされていたも
    のの一部は既に組み込んであります。 (filer.asm の中の余計な div 命令と, ems.
    asm の中の bx の push/pop の件)


 25)  sprinf.inc の不具合の修正 (榊原　知氏 :JAE01750)

      榊原　知 (NIFTY:JAE01750) さんにより，sprintf.incの不具合の修正差分が FVC
    にアップされましたが，ＦＭ版では，これを組み込んでみました。いずれ，オリジ
    ナルの方も正式に修正されるかもしれません。

      不具合というのは，有効桁の最上位より上の桁は，すべて同じ文字で埋めてしま
    うというものです。例えば，

      &?("%07,d",1)  →  0000001
      &?("%07d",-1)  →  00000-1

    と，なってしまいます。


 26)  [.] キーで親ディレクトリに移動する機能

      1.60 からファイラーのカスタマイズが VZFL.DEF でできるようになったため，従
    来の方法によるこの機能は削除しました。そのかわり，全く同等の機能をするよう
    に添付の VZFL.DEF に記述してあります。


-------------------------------------------------------------------------------
